import os
import pandas as pd
import torch
import torch.nn as nn
import nibabel as nib
import torch.optim as optim
from torch.utils.tensorboard import SummaryWriter
from monai.transforms import (
    Compose, LoadImaged, Spacingd, Transposed, ResizeWithPadOrCropd,
    ThresholdIntensityd, ScaleIntensityd, RandGaussianNoised, RandGaussianSharpend,
    RandRotate90d, RandFlipd, SaveImaged, SaveImage
)
from monai.data import DataLoader, CacheDataset
from monai.networks.nets import UNet
from monai.losses import DiceLoss
from sklearn.model_selection import train_test_split
from torch.optim.lr_scheduler import StepLR

# Function to load data
def load_data(df, folder_path, seg_folder_path, mask):
    image_paths = [os.path.join(folder_path, row['EAD']) for _, row in df.iterrows()]
    labels = [os.path.join(seg_folder_path, row['EAD'] + mask) for _, row in df.iterrows()]
    return image_paths, labels

# Read CSV file containing image paths and labels
csv_path = '/home/sruyss8/Ultimate_coordinates.csv'
df = pd.read_csv(csv_path)

# Define folder path containing DICOM images
folder_path = '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/'
seg_folder_path = '/usr/local/micapollo01/MIC/DATA/STUDENTS/sruyss8/NewMasks20/'
mask = '/multi_channel_mask.nii'

# Load image paths and labels
image_paths, labels = load_data(df, folder_path, seg_folder_path, mask)


val_transforms = Compose([
    LoadImaged(keys=['image'], ensure_channel_first=True),
    LoadImaged(keys=['label'], ensure_channel_first=False),   
    Spacingd(keys=['image'], pixdim=[0.8,0.8,0.8]),
    Transposed(keys=['image'], indices=[0, 2, 1, 3]),
    ResizeWithPadOrCropd(keys=['image'], spatial_size=(192, 192, 192)),
    ThresholdIntensityd(keys=['image'], threshold=0, above=True),
    ScaleIntensityd(keys=['image'])                 
])

# Define cases to predict and their paths
fold0 = ['60758646', '70332671', '71979520', '72394182', '74242124', '74324385', '74506262', '75237982', '78721909', '79135984', '81073918', '83693093', '84086115', '84493667', '84673904', '86097409', '87508164', '87561445', '87632055', '88305875', '88601463', '89048227', '89145189_L', '89253017', '89838957']
fold1 = ['65742318', '70606777', '71464200', '72183247', '72946270', '72949589', '73381857', '73401697', '73933582', '74111725', '75664730', '75831941', '76410141', '76846179', '77279263', '77600781', '79807202_2', '81286437', '83289488', '84487073', '85299105', '87546768', '88284534', '88652938', '89938633']
fold2 = ['60994782', '70142914', '70710629', '71038442', '71134217', '71372833', '72805559', '73572398', '73812968', '73941205', '74657172', '75296749', '77334779', '78949211', '80847403', '86139458', '86220027', '87318648', '87398467', '87490587', '88052246', '88063995', '88369517', '89157473', '89614499']
fold3 = ['60005199', '60919489', '62763313', '63937577', '70092747', '70131974', '70861380', '71922256', '74369133', '77103729', '77461895', '77491348', '78006491', '79807202', '84284926', '84735679', '85267102', '86628518', '87382792', '87474482', '88635370', '88805445', '89645188', '89648455', '89885404']
fold4 = ['60219401', '61752064', '62689583', '64988662', '66314071', '68783570', '70193826', '70371737', '70674437', '71355861', '71466577', '71879662', '73143240', '74925850', '78175155', '80889405', '81058331', '82399825', '83187138', '84042936', '84498724', '87626008', '88316104', '88460316']

fold0_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60758646', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70332671', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/71979520/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/72394182/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74242124', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74324385', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74506262', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/75237982/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/78721909/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/79135984/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/81073918', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83693093', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84086115', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/84493667/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84673904', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86097409', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/87508164/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87561445', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/87632055/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88305875', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88601463', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/89048227/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89145189_L', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/89253017/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89838957']
fold1_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/65742318', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70606777', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71464200', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/72183247/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/72946270/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/72949589', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73381857', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/73401697/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73933582', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74111725', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/75664730', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/75831941', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/76410141/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/76846179', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77279263', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77600781', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/79807202_2', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/81286437/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83289488', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84487073', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/85299105', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87546768', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88284534', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88652938', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89938633']
fold2_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/60994782/XXX/_Rechter_Knie_Bot_1.0_Br40_3', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70142914', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70710629', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71038442', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71134217', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71372833', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/72805559/XXX/_Beide_Knieen_Bot_1.0_Br40', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73572398', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73812968', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73941205', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74657172', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/75296749/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/77334779/XXX/_Rotatiemeting_1.0_Br59_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/78949211/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/80847403', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/86139458/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86220027', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87318648', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87398467', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87490587', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88052246', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88063995', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88369517', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89157473', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/89614499/XXX/_Knie_Bot_0.6_Ur70_VOL']
fold3_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/60005199/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60919489', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/62763313/78830916/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/63937577', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70092747', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/70131974/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70861380', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/71922256/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74369133', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/77103729/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/77461895/XXX/_Bekken_Bot_0.6_Hr60_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77491348', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/78006491', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/79807202', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/84284926/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/84735679/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/85267102', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86628518', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/87382792/XXX/_Rotatiemeting_1.0_Br59_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87474482', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/88635370/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/121-130/88805445/XXX/_Bekken_Bot_1.0_Br59_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/89645188/XXX/_Knie_Bot_0.4_Ur73_1_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/89648455/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89885404']
fold4_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60219401', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/61752064', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/111-120/62689583/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/64988662', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/141-150/66314071/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/68783570', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70193826', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70371737', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/70674437/XXX/_AX_BW_1_0.5', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71355861', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71466577', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/71879662/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73143240', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/74925850/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/78175155', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/80889405', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/81058331', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/82399825', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83187138', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84042936', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84498724', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87626008', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/131-140/88316104/XXX/_Knie_Bot_0.6_Ur70_VOL', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/22-05-dataset/101-110/88460316/XXX/_Rotatiemeting_1.0_Br59_VOL']

red_fold0 = ['60919489', '61752064', '63937577', '70092747', '71372833', '73381857', '78006491', '79807202', '82399825', '84487073', '87398467', '87546768', '88052246', '88063995', '88284534', '88652938', '89145189_L']
red_fold1 = ['71134217', '73933582', '74111725', '77600781', '80889405', '81073918', '83187138', '83289488', '85299105', '86628518', '87318648', '87474482', '87490587', '87626008', '88305875', '89157473', '89838957']
red_fold2 = ['60219401', '60758646', '65742318', '70142914', '70193826', '70861380', '71355861', '71466577', '73572398', '73812968', '74242124', '74324385', '76846179', '77279263', '81058331', '84086115', '85267102']
red_fold3 = ['68783570', '70371737', '70710629', '71464200', '72949589', '74657172', '75831941', '77491348', '78949211', '79807202_2', '83693093', '84498724', '84673904', '86097409', '86220027', '88601463']
red_fold4 = ['64988662', '70332671', '70606777', '71038442', '73143240', '73941205', '74369133', '74506262', '75664730', '78175155', '80847403', '84042936', '87561445', '88369517', '89885404', '89938633']

red_fold0_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60919489', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/61752064', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/63937577', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70092747', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71372833', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73381857', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/78006491', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/79807202', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/82399825', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84487073', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87398467', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87546768', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88052246', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88063995', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88284534', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88652938', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89145189_L']
red_fold1_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71134217', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73933582', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74111725', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77600781', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/80889405', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/81073918', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83187138', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83289488', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/85299105', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86628518', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87318648', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87474482', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87490587', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87626008', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88305875', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89157473', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89838957']
red_fold2_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60219401', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/60758646', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/65742318', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70142914', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70193826', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70861380', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71355861', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71466577', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73572398', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73812968', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74242124', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74324385', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/76846179', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77279263', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/81058331', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84086115', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/85267102']
red_fold3_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/68783570', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70371737', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70710629', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71464200', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/72949589', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74657172', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/75831941', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/77491348', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/78949211', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/79807202_2', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/83693093', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84498724', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84673904', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86097409', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/86220027', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88601463']
red_fold4_paths = ['/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/64988662', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70332671', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/70606777', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/71038442', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73143240', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/73941205', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74369133', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/74506262', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/75664730', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/78175155', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/80847403', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/84042936', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/87561445', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/88369517', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89885404', '/usr/local/micapollo01/MIC/DATA/STUDENTS/kkouko0/DATA/Knee_rotation/Knee_rotation_final/89938633']


cases = red_fold4
paths = red_fold4_paths

# Model setup
model_name = 'M25mask30Redfold4'

# Load the saved model
model_path = f'/usr/local/micapollo01/MIC/DATA/STUDENTS/sruyss8/UNet/{model_name}_model_state_dict.pth'
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model_state_dict = torch.load(model_path, map_location=device)

base_save_path = '/usr/local/micapollo01/MIC/DATA/STUDENTS/sruyss8/Predictions/UNet/'
save_prediction_path = os.path.join(base_save_path, model_name)

model = UNet(
    spatial_dims=3,
    in_channels=1,
    out_channels=4,
    channels=(4, 8, 16, 32, 64),
    strides=(2, 2, 2, 2),
    num_res_units=4,
)

if torch.cuda.device_count() > 1:
    model = nn.DataParallel(model)

model.load_state_dict(model_state_dict)
model.to(device)


# Evaluation loop
os.makedirs(save_prediction_path, exist_ok=True)

results = []

for case in cases:
    save_path = os.path.join(save_prediction_path,case)
    # save_transform = SaveImaged(keys='pred', output_dir=save_path, output_postfix='seg', resample=False)
    save_transform = SaveImage(output_dir=save_path, resample=False)


    # Find the string containing the substring and its index
    index = [ [i, s] for i, s in enumerate(image_paths) if case in s]

    train_labels = labels[index[0][0]]
    train_label = [f'{train_labels}']
    case_name = index[0][1]

    case_index = cases.index(case)
    train_paths = [paths[case_index]]

    print(train_paths,train_label)

    datadict=[{'image':img, 'label':label} for img, label in zip(train_paths, train_label)]

    # Create datasets and data loaders
    train_dataset = CacheDataset(datadict, transform=val_transforms)

    batch_size = 1
    val_loader = DataLoader(train_dataset, batch_size=batch_size, shuffle=True, num_workers=1)

    model.eval()
    with torch.no_grad():
        for val_data in val_loader:
            val_inputs = val_data['image'].to(device)
            val_outputs = model(val_inputs)
            val_outputs = val_outputs.squeeze()
            # val_data['pred'] = val_outputs  # Save raw logits output       
            for channel_idx in range(val_outputs.shape[0]):
                prediction_mask = val_outputs[channel_idx, :, :, :]

                save_filename = os.path.join(save_path, f'seg_channel_{channel_idx + 1}.nii')  # Unique filename for each prediction mask
                os.makedirs(os.path.dirname(save_filename), exist_ok=True)  # Create directories if they don't exist

                prediction_mask_np = prediction_mask.cpu().numpy()  # Convert Torch tensor to NumPy array
                img = nib.Nifti1Image(prediction_mask_np, affine=None)
                nib.save(img, save_filename)  # Save the image as a NIfTI file
